
$(document).ready(() => {
    const access_token = localStorage.getItem('access_token')
    $.ajax({
        url: 'https://data.esg-one.uk/esg1-api/api/GetKPIs?Id=1',
        method: "GET",
        headers: {
            Authorization: 'Bearer ' + access_token,
            "Content-Type": "application/json"
        },
        success: function (data) {
            console.log('success', data);

            const splittedData = splitByFour(data);
            splittedData.forEach(function (chunk) {
                console.log(chunk)
                populateCardTemplate(chunk)
            })

            $('#kpis-sort-cards').find('.carousel-item:first').addClass('active')
            $('#template-card').remove()

        },
        error: function (e) {
            console.log('error getting kpis api:', e)
        }
    })
})

function splitByFour(arr) {
    const res = []

    for (let i = 0; i < arr.length; i += 4) {
        if (arr[i].Active)
            res.push(arr.slice(i, i + 4));
    }

    return res;
}

function populateCardTemplate(cardData) {
    const newCarouselElement = $('<div class="carousel-item"></div>')
    const row = $('<div class="kpi-cards-container"></div>')
    newCarouselElement.append(row);

    for (let i = 0; i < cardData.length; i++) {

        // Clone the card template
        const cardElement = $('#template-card').clone();

        // Remove the ID attribute from the cloned card element
        cardElement.removeAttr('id');

        // Set the title, info, and numbers using the unique identifiers
        cardElement.find('#kpi-card-name').text(cardData[i].Name);
        cardElement.find('#kpi-card-info').text(cardData[i].Info ? cardData[i].Info : 'no info available');
        cardElement.find('#kpi-card-unit').text(cardData[i].Unit);
        cardElement.find('#kpi-card-value').text(cardData[i].Value);

        let icon;
        switch (cardData[i].IconRef) {
            case "Earth":
                icon = $('<i class="ni ni-world-2"></i>')
                break;
            case "Person":
                icon = $('<i class="ni ni-circle-08"></i>')
                break;
            case "Money":
                icon = $('<i class="ni ni-money-coins"></i>');
                break;
            default:
                icon = $('<i class="ni ni-fat-remove"></i>');

        }
        cardElement.find('#kpi-card-icon').html(icon)
        // Set the target info using the unique identifier
        const targetInfoElement = cardElement.find('#target-info');

        if (cardData[i].Target) {
            if (cardData[i].TargetType === "Below") {
                cardElement.find('#kpi-card-target-info').addClass('text-danger')
                targetInfoElement.html('<i class="fa fa-arrow-down"></i>' + cardData[i].Target);
            }
            else {
                cardElement.find('#kpi-card-target-info').addClass('text-success')
                targetInfoElement.html('<i class="fa fa-arrow-up"></i>' + cardData[i].Target);
            }
        }
        else {
            cardElement.find("#target-info").addClass('invisible')
        }

        const col = $('<div class="kpi-card-item"></div>');
        // Append the populated card to the desired container
        col.append(cardElement);
        row.append(col);

    }
    $('#kpis-sort-cards').append(newCarouselElement)


}
