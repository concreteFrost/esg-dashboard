$(document).ready(() => {
  if (location.pathname.endsWith('risk-overview.html')) {
    $('#risks-view-all').hide();
    $('#risks').removeClass('col-xl-6');
    $('#add-risk-btn').removeClass('d-none');
  }
});

$.ajax({
  setup,
  success: function (data) {
    getRisk(data);
  },
  error: function (e) {
    console.log(e);
  },
});

function getRisk(data) {
  $.ajax({
    url: 'https://europe.grc1.com/iGRC/api/Risk/Get',
    async: true,
    crossDomain: true,
    method: 'GET',
    data: {
      tenantName: 'ESG-ONE',
    },
    beforeSend: function (xhr) {
      xhr.setRequestHeader('Authorization', 'Bearer ' + data.access_token);
    },

    success: function (data2) {
      //Remove Pre-Loader
      $('#risk-datatable').parent().next().remove();

      console.log(data2);
      const riskArr = data2;
      riskArr.forEach((risk) => {
        let subCat = '';
        var riskCategory = '';
        if (risk.RiskCategory && risk.RiskCategory.RiskCategoryName) {
          riskCategory = risk.RiskCategory.RiskCategoryName;
        }

        if (risk.RiskSubCategory && risk.RiskSubCategory.RiskSubCategoryName) {
          subCat = risk.RiskSubCategory.RiskSubCategoryName;
        }

        const el = `<tr>
        <td><a href="/dashboard/company/individual-risk.html" onclick="redirectToRisk(this)" data-id=${risk.RiskId}> ${risk.RiskName} </a></td>
                  <td>${risk.CurrentResidualRiskScore}</td>
                  <td>${risk.GrossExposureScore}</td>
                  <td>${risk.RegisterTargetScore}</td>
                  <td>${risk.Company.CompanyName}</td>
                  <td> ${risk.Office.OfficeName}</td>
                  <td> ${risk.BusinessUnit.BusinessUnitName}</td> 
                  <td>${risk.LinkedControlNumbers}</td>
                  <td>${risk.RiskAppetite}</td>
                  <td>${risk.Proximity.ProximityName}</td>
                  <td>${riskCategory}</td>
                  <td>${subCat}</td>
                  <td>${risk.RiskType.Description}</td>
                  <td>${risk.ImpactType}</td>
                  <td>${risk.Response.ResponseName}</td>
                  <td>            
                  <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#editRiskModal">edit</button>
                  <button class="btn btn-danger btn-sm" onclick="performDeletion(this)">delete</button></td>
                    </tr>`;

        $('#risk-table-body').append(el);
      });
      createTable('#risk-datatable');
    },
    error: function (e) {
      console.log(e);
    },
  });
}

function performDeletion(e) {
  $(e).closest('tr').remove();
}

function redirectToRisk(e) {
  localStorage.setItem('risk id', $(e).data('id'));
}
