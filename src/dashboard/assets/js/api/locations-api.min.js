var flag;
var latlng;
var country_name;
var editable_branch;

$(document).ready(() => {
  if (location.pathname.endsWith('locations.html')) {
    $('#locations-view-all').hide();
    $('#manage-locations-btn').removeClass('d-none');
    $('#locations').removeClass('col-xl-6');
    $('#locations').addClass('col');
  }
  $('#locations-list').html(localStorage.getItem('locations list'));
  const markers =JSON.parse(localStorage.getItem('map markers'));

  markers.forEach((e)=>{
    VectorMap.addMarker(e.title,e.latlng)
  })
});

var VectorMap = new jvm.Map({
  container: $('#world-map'),
  map: 'world_mill',
  zoomOnScroll: true,
  normalizeFunction: 'polynomial',
  hoverOpacity: 1,
  hoverColor: !1,
  backgroundColor: 'transparent',
  regionStyle: {
    initial: {
      fill: '#dae9f7',
    },
    hover: { fill: '#1864AD', 'fill-opacity': 0.8, cursor: 'pointer' },
    selected: { fill: '#0C4E9D' },
    selectedHover: { fill: '#1864AD' },
  },
  markerStyle: {
    initial: { fill: '#F49986', 'stroke-width': 0 },
    hover: { fill: '#0C4E9D', 'stroke-width': 0 },
  },
  markers: [],
  series: {
    regions: [
      {
        values: {},
        scale: ['#C8EEFF', '#0071A4'],
        normalizeFunction: 'polynomial',
      },
    ],
  },
});
$(document).find('.jvectormap-zoomin').addClass('btn btn-sm btn-primary');
$(document).find('.jvectormap-zoomout').addClass('btn btn-sm btn-primary');

//Open Manage locations window
$('#manage-locations-btn').on('click', () => {
  $('#new-location').removeClass('d-none');
  $('#save-loaction-changes-btn').addClass('d-none');
  $('#save-new-location-btn').removeClass('d-none');
  $.ajax({
    url: 'https://restcountries.com/v3.1/all',
    method: 'GET',

    success: function (data) {
      $('#new-location').empty();
      data.sort(function (a, b) {
        var name1 = a.name.common.toUpperCase();
        var name2 = b.name.common.toUpperCase();
        return name1 < name2 ? -1 : name1 > name2 ? 1 : 0;
      });
      data.forEach((element) => {
        let name = element.name.common;
        let cca2 = element.cca2;
        $('#new-location').append(`<option value=${cca2}>${name}</option>`);
      });
    },
    error: function (e) {
      console.log(e);
    },
  });
});

//Get Flag of selected country
$('#new-location').change(() => {
  getFlag();
});

//Add new location to list
$('#save-new-location-btn').click(() => {

  VectorMap.addMarker($('#new-location option:selected').text(), latlng);
  var content = `<li class="list-group-item px-0 location">
  <div class="row align-items-center">
    <div class="col-auto">
      <!-- Country flag -->
      <img
        class="flags"
        src="${flag}"
      />
    </div>
    <div class="col">
      <small>Country</small>
      <h5 class="mb-0">${$('#new-location option:selected').text()}</h5>
    </div>
    <div class="col">
      <small>Branches</small>
      <h5 class="mb-0">${$('#branches').val()}</h5>
    </div>
    <div class="col">
      <small>Perform. vs Mean</small>
      <h5 class="mb-0 text-danger">-</h5>
    </div>
    <div class="col">
    <ul class="list-group list-group-horizontal float-right ">
      <li  class="list-group-item border-0 pr-0"> <button class="btn btn-primary btn-sm" onclick="editLocation(this)">Edit</button></li>
      <li  class="list-group-item border-0 pl-1"> <button class="btn btn-danger btn-sm" onclick="removeLocation(this)"
      data-name=${country_name} data-location=${latlng}>Delete</button></li>
    </ul>
  </div>
  </div>
</li>`;
  $('#locations-list').append(content);
  $('#locationsModalCenter').modal('hide');
  localStorage.setItem('locations list', $('#locations-list').html());

  //Add markers to local storage
  updateLocalStorageMarkers();

});

//Remove existing location
function removeLocation(e) {
  $(e).closest('.location').remove();
  console.log($(e).data('name'))
  VectorMap.removeAllMarkers()
  localStorage.setItem('locations list', $('#locations-list').html());
  localStorage.setItem('map markers', null)
}

//Save changes to existing location
$('#save-loaction-changes-btn').click(() => {
  $('#locationsModalCenter').modal('hide');
  editable_branch.html($('#branches').val());
  localStorage.setItem('locations list', $('#locations-list').html());
});

//Show/hide message if list is empty
$(document).on('DOMSubtreeModified', () => {
  $('#locations-list').children().length > 0
    ? $('#no-locations').addClass('d-none')
    : $('#no-locations').removeClass('d-none');
});

//Open edit location window
function editLocation(e) {
  $('#locationsModalTitle').html('Edit location');
  $('#save-loaction-changes-btn').removeClass('d-none');
  $('#save-new-location-btn').addClass('d-none');
  $('#new-location').addClass('d-none');
  let country = $(e).closest('.row').children('div:eq(1)').find('h5').html();
  let branches = $(e).closest('.row').children('div:eq(2)').find('h5').html();

  $('#locationsModalCenter').modal('show');
  $('#branches').val(branches);
  $('#new-location option:selected').val(country);

  editable_branch = $(e).closest('.row').children('div:eq(2)').find('h5');
}

function updateLocalStorageMarkers(){
  var existingMarkers =JSON.parse(localStorage.getItem('map markers'));
  if(!existingMarkers){
    existingMarkers =[]
  }
  var title = $('#new-location option:selected').text();
  var newMarker ={
    'title' : title,
    latlng : latlng 
  }

  localStorage.setItem('map marker', newMarker)
  existingMarkers.push(newMarker);
  localStorage.setItem('map markers',JSON.stringify(existingMarkers));
}

function getFlag() {
  $.ajax({
    url: 'https://restcountries.com/v2/alpha/' + $('#new-location').val(),
    method: 'GET',
    success: function (data) {
      flag = data.flags.png;
      latlng = data.latlng;
      country_name = data.name;
    },
    error: function (e) {
      console.log('error');
    },
  });
}