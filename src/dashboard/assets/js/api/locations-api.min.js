var table;
$(document).ready(() => {
  if (location.href.endsWith('locations.html')) {
    $('#locations').removeClass('col-xl-6').addClass('col-12')
    $('#locations-view-all').hide();
    $('#locations-card-body').removeClass('locations-homepage')
  }
  table = $('#locations-list').DataTable({
    dom: 'Bfrltp',
    language: {
      paginate: {
        previous: "<i class='fas fa-angle-left'>",
        next: "<i class='fas fa-angle-right'>",
      },
      lengthMenu: 'Display _MENU_',
    },
    buttons: [
      {
        extend: 'collection',
        text: 'Show columns',
        columns: '.colhead',
        className: 'btn-outline-primary btn-sm ',
        buttons: ['columnsVisibility'],
        visibility: !0,
      },
      {
        extend: 'print',
        className: 'btn-datatable btn-sm',
      },
      {
        extend: 'pdf',
        className: 'btn-datatable btn-sm',
      },
      {
        extend: 'excel',
        className: 'btn-datatable btn-sm',
      },
      {
        extend: 'copy',
        className: 'btn-datatable btn-sm',
      },
    ],
  });
})

//Get Markers on a page load
$.ajax({
  setup,
  success: function (data) {
    $.ajax({
      url: 'https://europe.grc1.com/iGRC/api/Office/Get',
      data: {
        tenantName: 'ESG One - Production',
      },
      method: 'GET',
      headers: {
        Authorization: 'BEARER ' + data.access_token,
      },
      success: function (data2) {
        //Use this object to highlight regions on start
        $('.api-loader').hide()

        //Bring this back

        // var regionHighLight = {};
        // data2.forEach((d) => {
        //   $.ajax({
        //     url:
        //       'https://restcountries.com/v3.1/alpha/' + d.Country.CountryCode,
        //     method: 'GET',
        //     success: function (countryInfo) {
        //       VectorMap.addMarker(
        //         countryInfo[0].name.common,
        //         countryInfo[0].latlng
        //       );
        //       var btns = ` <button class="btn btn-primary btn-sm" 
        //       onclick="editLocation(this)">Edit</button>
        //       <button class="btn btn-danger btn-sm" onclick="removeLocation(this)" 
        //       data-iso="${d.Country.CountryCode}" 
        //       data-country="${countryInfo[0].name.common}" 
        //       data-latlng="${countryInfo[0].latlng}">Delete</button>`;

        //       table.row.add([
        //         `<img src="${countryInfo[0].flags.png}" width="40px">`,
        //         d.Country.CountryName,
        //         d.OfficeName,
        //         d.Country.CurrencyCode,
        //         d.IsCurrent ? 'yes' : 'no',
        //         btns,
        //       ]);
        //       table.draw();
        //       regionHighLight[d.Country.CountryCode] = '1';
        //       VectorMap.series.regions[0].setValues(regionHighLight);
        //     },
        //   });
        // });
      },
    });
  },
});

//Remove existing location
function removeLocation(e) {
  table.row($(e).closest('tr')).remove().draw()
  VectorMap.removeMarkers([$(e).data('country')]);
  var obj = {};
  obj[$(e).data('iso')] = '0';
  VectorMap.series.regions[0].setValues(obj);
}

//Open Manage locations window
$('#manage-locations-btn').on('click', () => {
  $('#new-location').removeClass('d-none');
  $('#save-loaction-changes-btn').addClass('d-none');
  $('#save-new-location-btn').removeClass('d-none');
  $.ajax({
    url: 'https://restcountries.com/v3.1/all',
    method: 'GET',

    success: function (data) {
      $('#new-location').empty();
      data.sort(function (a, b) {
        var name1 = a.name.common.toUpperCase();
        var name2 = b.name.common.toUpperCase();
        return name1 < name2 ? -1 : name1 > name2 ? 1 : 0;
      });
      data.forEach((element) => {
        let name = element.name.common;
        let cca2 = element.cca2;
        $('#new-location').append(`<option value=${cca2}>${name}</option>`);
      });
    },
    error: function (e) { },
  });
});

//Add new location to list
$('#save-new-location-btn').click(() => {
  $.ajax({
    url:
      'https://restcountries.com/v2/alpha/' +
      $('#new-location option:selected').val(),
    method: 'GET',
    success: function (data) {
      var btns = ` <button class="btn btn-primary btn-sm" 
      onclick="editLocation(this)">Edit</button>
      <button class="btn btn-danger btn-sm" onclick="removeLocation(this)" 
      data-iso="${data.alpha2Code}" 
      data-country="${data.name}" 
      data-latlng="${data.latlng}">Delete</button>`;
      table.row.add([
        `<img src="${data.flags.png}" width="40px">`,
        data.name,
        data.alpha2Code,
        data.currencies[0].name,
        $('#isActive').is(':checked') ? 'yes' : 'no',
        data.latlng,
        btns,

      ]);
      VectorMap.addMarker(data.name, data.latlng);
      var obj = {};
      obj[data.alpha2Code] = '1';
      VectorMap.series.regions[0].setValues(obj);
      table.draw();
      $('#locationsModalCenter').modal('hide');
    },
  });
});

//Save changes to existing location
$('#save-loaction-changes-btn').click(() => {
  $('#locationsModalCenter').modal('hide');
  editable_branch.html($('#branches').val());
  localStorage.setItem('locations list', $('#locations-list').html());
});

//Show/Hide no locations message
$(document).on('DOMSubtreeModified', () => {
  $('#country-table-body').children().length > 0 || $('#homepage-locations').children().length
    ? $('#no-locations').addClass('d-none')
    : $('#no-locations').removeClass('d-none');
});